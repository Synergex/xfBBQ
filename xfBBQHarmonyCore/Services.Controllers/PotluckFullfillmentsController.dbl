;;*****************************************************************************
;;
;; Title:       PotluckFullfillmentsController.dbl
;;
;; Description: OData controller for the POTLUCK_FULLFILLMENT structure.
;;
;;*****************************************************************************
;; WARNING: GENERATED CODE!
;; This file was generated by CodeGen. Avoid editing the file if possible.
;; Any changes you make will be lost of the file is re-generated.
;;*****************************************************************************

import Microsoft.AspNetCore.Authorization
import Microsoft.AspNetCore.Http
import Microsoft.OData
import Microsoft.AspNetCore.JsonPatch
import Microsoft.AspNetCore.Mvc
import Microsoft.AspNet.OData
import Microsoft.AspNet.OData.Routing
import Microsoft.EntityFrameworkCore
import Microsoft.EntityFrameworkCore.Infrastructure
import Microsoft.Extensions.Options
import System.Collections.Generic
import System.ComponentModel.DataAnnotations
import Harmony.Core.EF.Extensions
import Harmony.Core.Interface
import Harmony.OData
import Harmony.AspNetCore
import Newtonsoft.Json
import Services.Models

namespace Services.Controllers

    {Authorize}
    {ApiVersion("1")}
    {ODataRoutePrefix("PotluckFullfillments")}
    ;;; <summary>
    ;;; OData controller for PotluckFullfillments
    ;;; </summary>
    public partial class PotluckFullfillmentsController extends ODataController
    
        ;;Services provided via dependency injection
        private _DbContext, @Services.Models.DBContext
        private _ServiceProvider, @IServiceProvider
        private _AppSettings, @IOptions<AppSettings>

        ;;; <summary>
        ;;; Constructs a new instance of PotluckFullfillmentsController
        ;;; </summary>
        ;;; <param name="aDbContext">Database context instance (DI)</param>
        ;;; <param name="aServiceProvider">Service provider instance (DI)</param>
        ;;; <param name="aAppSettings">Application settings</param>
        public method PotluckFullfillmentsController
            aDbContext, @Services.Models.DBContext
            aServiceProvider, @IServiceProvider
            aAppSettings, @IOptions<AppSettings>
        proc
            this._DbContext = aDbContext
            this._ServiceProvider = aServiceProvider
            this._AppSettings = aAppSettings
        endmethod

        {ODataRoute}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(ODataValue<IEnumerable<PotluckFullfillment>>),StatusCodes.Status200OK)}
        {EnableQuery(MaxExpansionDepth=4)}
        ;;; <summary>
        ;;; Get all PotluckFullfillments
        ;;; </summary>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method GetPotluckFullfillments, @IActionResult
        proc
            mreturn Ok(_DbContext.PotluckFullfillments.AsNoTracking())
        endmethod

        {ODataRoute("(Id={aId})")}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(PotluckFullfillment),StatusCodes.Status200OK)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {EnableQuery(MaxExpansionDepth=4)}
        ;;; <summary>
        ;;; Get a single PotluckFullfillment by primary key.
        ;;; </summary>
        ;;; <param name="aId">Item id</param>
        ;;; <returns>Returns a SingleResult indicating the status of the operation and containing any data that was returned.</returns>
        public method GetPotluckFullfillment, @SingleResult<PotluckFullfillment>
            {FromODataUri}
            required in aId, int
        proc
            mreturn new SingleResult<PotluckFullfillment>(_DbContext.PotluckFullfillments.AsNoTracking().FindQuery<PotluckFullfillment>(_DbContext, aId))
        endmethod

        {ODataRoute("(Bbqid={aBbqid},Itemid={aItemid})")}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(ODataValue<IEnumerable<PotluckFullfillment>>),StatusCodes.Status200OK)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {EnableQuery(MaxExpansionDepth=4)}
        ;;; <summary>
        ;;; Get potluckFullfillments by alternate key key Bbqid.
        ;;; </summary>
        ;;; <param name="aBbqid">BBQ id</param>
        ;;; <param name="aItemid">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method GetPotluckFullfillmentsByBbqid, @IActionResult
            {FromODataUri}
            required in aBbqid, int
            {FromODataUri}
            required in aItemid, int
        proc
            data result = _DbContext.PotluckFullfillments.AsNoTracking().FindAlternate("Bbqid",aBbqid,"Itemid",aItemid)
            if (result == ^null)
                mreturn NotFound()
            mreturn Ok(result)
        endmethod

        {ODataRoute("(Userid={aUserid},Bbqid={aBbqid},Itemid={aItemid})")}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(ODataValue<IEnumerable<PotluckFullfillment>>),StatusCodes.Status200OK)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {EnableQuery(MaxExpansionDepth=4)}
        ;;; <summary>
        ;;; Get potluckFullfillments by alternate key key User.
        ;;; </summary>
        ;;; <param name="aUserid">user id bringing item</param>
        ;;; <param name="aBbqid">BBQ id</param>
        ;;; <param name="aItemid">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method GetPotluckFullfillmentsByUser, @IActionResult
            {FromODataUri}
            required in aUserid, int
            {FromODataUri}
            required in aBbqid, int
            {FromODataUri}
            required in aItemid, int
        proc
            data result = _DbContext.PotluckFullfillments.AsNoTracking().FindAlternate("Userid",aUserid,"Bbqid",aBbqid,"Itemid",aItemid)
            if (result == ^null)
                mreturn NotFound()
            mreturn Ok(result)
        endmethod

        {ODataRoute("(Itemid={aItemid})")}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(ODataValue<IEnumerable<PotluckFullfillment>>),StatusCodes.Status200OK)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {EnableQuery(MaxExpansionDepth=4)}
        ;;; <summary>
        ;;; Get potluckFullfillments by alternate key key Itemid.
        ;;; </summary>
        ;;; <param name="aItemid">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method GetPotluckFullfillmentsByItemid, @IActionResult
            {FromODataUri}
            required in aItemid, int
        proc
            data result = _DbContext.PotluckFullfillments.AsNoTracking().FindAlternate("Itemid",aItemid)
            if (result == ^null)
                mreturn NotFound()
            mreturn Ok(result)
        endmethod

        {ODataRoute}
        {Produces("application/json")}
        {ProducesResponseType(^typeof(PotluckFullfillment),StatusCodes.Status200OK)}
        {ProducesResponseType(StatusCodes.Status400BadRequest)}
        {HttpPost}
        ;;; <summary>
        ;;; Create a new potluckFullfillment (automatically assigned primary key).
        ;;; </summary>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method PostPotluckFullfillment, @IActionResult
            {FromBody}
            required in aPotluckFullfillment, @PotluckFullfillment
        proc
            ;;Remove the primary key fields from ModelState
            ModelState.Remove("Id")

            ;; Validate inbound data
            if (!ModelState.IsValid)
                mreturn ValidationHelper.ReturnValidationError(ModelState)

            ;;Get the next available primary key value
            disposable data keyFactory = (@IPrimaryKeyFactory)_ServiceProvider.GetService(^typeof(IPrimaryKeyFactory))
            KeyFactory.AssignPrimaryKey(aPotluckFullfillment)

            ;;Add the new potluckFullfillment
            try
            begin
                _DbContext.PotluckFullfillments.Add(aPotluckFullfillment)
                _DbContext.SaveChanges(keyFactory)
            end
            catch (e, @ValidationException)
            begin
                ModelState.AddModelError("RelationValidation",e.Message)
                mreturn ValidationHelper.ReturnValidationError(ModelState)
            end
            endtry

            mreturn Created(aPotluckFullfillment)

        endmethod

        {ODataRoute("(Id={aId})")}
        {Produces("application/json")}
        {ProducesResponseType(StatusCodes.Status201Created)}
        {ProducesResponseType(StatusCodes.Status400BadRequest)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {HttpPut}
        ;;; <summary>
        ;;; Create (with a client-supplied primary key) or replace a potluckFullfillment.
        ;;; </summary>

        ;;; <param name="aId">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method PutPotluckFullfillment, @IActionResult
            {FromODataUri}
            required in aId, int
            {FromBody}
            required in aPotluckFullfillment, @PotluckFullfillment
        proc
            ;; Validate inbound data
            if (!ModelState.IsValid)
                mreturn ValidationHelper.ReturnValidationError(ModelState)

            ;;Ensure that the key values in the URI win over any data that may be in the model object
            aPotluckFullfillment.Id = aId

            try
            begin
                ;;Add and commit
                data existing = _DbContext.PotluckFullfillments.Find(aId)
                if(existing == ^null) then
                begin
                    _DbContext.PotluckFullfillments.Add(aPotluckFullfillment)
                    _DbContext.SaveChanges()
                    mreturn Created(aPotluckFullfillment)
                end
                else
                begin
                    aPotluckFullfillment.CopyTo(existing)
                    _DbContext.SaveChanges()
                    mreturn NoContent()
                end
            end
            catch (e, @InvalidOperationException)
            begin
                mreturn BadRequest(e)
            end
            catch (e, @ValidationException)
            begin
                ModelState.AddModelError("RelationValidation",e.Message)
                mreturn ValidationHelper.ReturnValidationError(ModelState)
            end
            endtry

        endmethod
        {ODataRoute("(Id={aId})")}
        {Produces("application/json")}
        {ProducesResponseType(StatusCodes.Status204NoContent)}
        {ProducesResponseType(StatusCodes.Status400BadRequest)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {HttpPatch}
        ;;; <summary>
        ;;; Patch  (partial update) a potluckFullfillment.
        ;;; </summary>
        ;;; <param name="aId">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method PatchPotluckFullfillment, @IActionResult
            {FromODataUri}
            required in aId, int
            {FromBody}
            required in aPotluckFullfillment, @JsonPatchDocument<PotluckFullfillment>
        proc
            ;; Validate inbound data
            if (!ModelState.IsValid)
                mreturn ValidationHelper.ReturnValidationError(ModelState)

            ;;Patch the existing potluckFullfillment
            try
            begin
                ;;Get the potluckFullfillment to be updated
                data potluckFullfillmentToUpdate = _DbContext.PotluckFullfillments.Find(aId)
                data patchError, @JsonPatchError, ^null
                ;;Did we find it?
                if(potluckFullfillmentToUpdate == ^null)
                    mreturn NotFound()

                ;;Apply the changes to the potluckFullfillment we read
                aPotluckFullfillment.ApplyTo(potluckFullfillmentToUpdate, lambda(error) { patchError = error })
                ;;if the patchdoc was bad return the error info
                if(patchError != ^null)
                    mreturn BadRequest(string.Format("Error applying patch document: error message {0}, caused by {1}", patchError.ErrorMessage, JsonConvert.SerializeObject(patchError.Operation)))

                ;;Update and commit
                _DbContext.PotluckFullfillments.Update(potluckFullfillmentToUpdate)
                _DbContext.SaveChanges()
            end
            catch (e, @InvalidOperationException)
            begin
                mreturn BadRequest(e)
            end
            catch (e, @ValidationException)
            begin
                ModelState.AddModelError("RelationValidation",e.Message)
                mreturn ValidationHelper.ReturnValidationError(ModelState)
            end
            endtry

            mreturn NoContent()

        endmethod
        {ODataRoute("(Id={aId})")}
        {ProducesResponseType(StatusCodes.Status204NoContent)}
        {ProducesResponseType(StatusCodes.Status404NotFound)}
        {HttpDelete}
        ;;; <summary>
        ;;; Delete a potluckFullfillment.
        ;;; </summary>
        ;;; <param name="aId">Item id</param>
        ;;; <returns>Returns an IActionResult indicating the status of the operation and containing any data that was returned.</returns>
        public method DeletePotluckFullfillment, @IActionResult
            {FromODataUri}
            required in aId, int
        proc
            ;;Get the potluckFullfillment to be deleted
            data potluckFullfillmentToRemove = _DbContext.PotluckFullfillments.Find(aId)

            ;;Did we find it?
            if (potluckFullfillmentToRemove == ^null)
                mreturn NotFound()

            ;;Delete and commit
            _DbContext.PotluckFullfillments.Remove(potluckFullfillmentToRemove)
            _DbContext.SaveChanges()

            mreturn NoContent()

        endmethod
    endclass

endnamespace